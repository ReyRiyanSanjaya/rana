// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// CORE TENANCY & IAM
// ================================

model Tenant {
  id                 String             @id @default(uuid())
  name               String
  plan               SubscriptionPlan   @default(FREE)
  trialEndsAt        DateTime? // Date when trial expires
  subscriptionEndsAt DateTime? // [NEW] Subscription expiry date based on package
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  users        User[]
  stores       Store[]
  products     Product[]
  categories   Category[]
  customers    Customer[]
  transactions Transaction[]

  // Reporting Aggregates
  dailySales           DailySalesSummary[]
  productStats         ProductSalesSummary[]
  cashLogs             CashflowLog[]
  purchases            Purchase[]
  debtRecords          DebtRecord[]
  subscriptionRequests SubscriptionRequest[] // [FIX] Added relation
  wholesaleOrders      WholesaleOrder[] // [FIX] Added relation
  tickets              SupportTicket[] // [NEW]
  notifications        Notification[] // [NEW]
  ppobTransactions     PpobTransaction[] // [NEW]
  flashSales           FlashSale[] // [FIX] Added relation
  referralCodes        ReferralCode[]
  referralsAsReferrer  Referral[]          @relation("TenantAsReferrer")
  referralsAsReferee   Referral[]          @relation("TenantAsReferee")
  referralRewards      ReferralReward[]    @relation("ReferralRewardTenant")
}

model Notification {
  id        String   @id @default(uuid())
  tenantId  String
  title     String
  body      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
}

// [NEW] Configurable Packages
model SubscriptionPackage {
  id           String   @id @default(uuid())
  name         String // e.g. "Bulanan", "Tahunan"
  price        Float // e.g. 49000
  durationDays Int // e.g. 30
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  subscriptionRequests SubscriptionRequest[] // [NEW] Reverse relation
}

model SubscriptionRequest {
  id        String        @id @default(uuid())
  tenantId  String
  packageId String? // [NEW] Selected package
  proofUrl  String?
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  tenant  Tenant               @relation(fields: [tenantId], references: [id])
  package SubscriptionPackage? @relation(fields: [packageId], references: [id]) // [NEW]
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  storeId      String? // If null, can access all stores (Admin)
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(CASHIER)
  createdAt    DateTime @default(now())

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  store        Store?        @relation(fields: [storeId], references: [id])
  transactions Transaction[]

  loginHistory LoginHistory[]
}

enum UserRole {
  OWNER
  ADMIN
  STORE_MANAGER
  CASHIER
  SUPER_ADMIN
}

model LoginHistory {
  id        String   @id @default(uuid())
  userId    String
  ip        String?
  userAgent String?
  loginAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// ================================
// BUSINESS DATA
// ================================

// 
model Store {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  location  String?
  latitude  Float? // [NEW] For Map Visualization
  longitude Float? // [NEW] For Map Visualization
  category  String? // [NEW] UMKM Category (Apotik, Kedai, etc.)
  waNumber  String?  @unique // [NEW] For WhatsApp Notifications
  imageUrl  String?
  bannerUrl String?  // [NEW] Store banner
  description String? // [NEW] Store description
  openingHours String? // [NEW] e.g. "09:00 - 21:00"
  isActive     Boolean  @default(true) // [FIX] Added missing field
  balance   Float    @default(0) // [NEW] Digital Wallet Balance
  createdAt DateTime @default(now())

  tenant            Tenant              @relation(fields: [tenantId], references: [id])
  users             User[]
  transactions      Transaction[]
  dailySales        DailySalesSummary[]
  stock             Stock[]
  cashLogs          CashflowLog[]
  debts             DebtRecord[]
  purchases         Purchase[]
  withdrawals       Withdrawal[] // [NEW]
  topUps            TopUpRequest[] // [NEW]
  sentTransfers     WalletTransfer[]    @relation("SentTransfers") // [NEW]
  receivedTransfers WalletTransfer[]    @relation("ReceivedTransfers") // [NEW]
  ppobTransactions  PpobTransaction[] // [NEW]
  flashSales        FlashSale[] // [FIX] Added relation
  products          Product[]
}

// [NEW] Withdrawal Request
model Withdrawal {
  id            String           @id @default(uuid())
  storeId       String
  amount        Float
  fee           Float            @default(0) // [NEW] Platform Fee applied
  netAmount     Float            @default(0) // [NEW] Final amount transferred
  bankName      String
  accountNumber String
  status        WithdrawalStatus @default(PENDING)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt // Track approval time

  store Store @relation(fields: [storeId], references: [id])
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
}

// [NEW] Global Announcements
model Announcement {
  id          String   @id @default(uuid())
  title       String
  content     String
  isActive    Boolean  @default(true)
  target      String   @default("ALL") // ALL, PLAN, STATUS, STORE
  targetValue String? // e.g. "PREMIUM", "ACTIVE", or StoreID
  createdAt   DateTime @default(now())
}

model Supplier {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  phone     String?
  address   String?
  createdAt DateTime @default(now())

  purchases Purchase[]
}

model Purchase {
  id          String   @id @default(uuid())
  tenantId    String
  storeId     String
  supplierId  String?
  totalAmount Float
  purchasedAt DateTime @default(now())

  tenant   Tenant         @relation(fields: [tenantId], references: [id])
  store    Store          @relation(fields: [storeId], references: [id])
  supplier Supplier?      @relation(fields: [supplierId], references: [id])
  items    PurchaseItem[]
}

model PurchaseItem {
  id         String @id @default(uuid())
  purchaseId String
  productId  String
  quantity   Int
  costPrice  Float // Price at the moment of purchase

  purchase Purchase @relation(fields: [purchaseId], references: [id])
}

// ... existing models ...

model Product {
  id           String   @id @default(uuid())
  tenantId     String
  storeId      String? // If null, is a global template or HQ product
  name         String
  description  String?
  sku          String?
  barcode      String?
  basePrice    Float
  sellingPrice Float
  stock        Int      @default(0)
  categoryId   String?
  imageUrl     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant        Tenant            @relation(fields: [tenantId], references: [id])
  store         Store?            @relation(fields: [storeId], references: [id])
  category      Category?         @relation(fields: [categoryId], references: [id])
  stocks        Stock[]
  sales         TransactionItem[]
  inventoryLogs InventoryLog[]
  minStock      Int               @default(5)

  // [NEW] Discount features
  originalPrice  Float? // For storing price before discount
  discountLabel  String? // e.g. "Flash Sale"
  flashSaleItems FlashSaleItem[] // [FIX] Added relation
  
  // [NEW] Favorites & Reviews
  favorites     Favorite[]
  reviews       Review[]
  averageRating Float      @default(0)
  reviewCount   Int        @default(0)
}

model Review {
  id        String   @id @default(uuid())
  productId String
  userId    String?  // Optional if we want to link to User/Customer
  userName  String   // Display Name
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())

  product   Product  @relation(fields: [productId], references: [id])
}

model Favorite {
  id        String   @id @default(uuid())
  phone     String   // Customer Phone (Simple Auth)
  productId String
  createdAt DateTime @default(now())

  product   Product  @relation(fields: [productId], references: [id])
  
  @@unique([phone, productId])
}

enum InventoryType {
  IN
  OUT
  ADJUSTMENT
}

model InventoryLog {
  id        String        @id @default(uuid())
  productId String
  storeId   String? // Optional: track which store if product is global? assuming product is store-specific or we trust productId
  type      InventoryType
  quantity  Int
  reason    String?
  createdAt DateTime      @default(now())

  product Product @relation(fields: [productId], references: [id])
}

model Category {
  id       String    @id @default(uuid())
  tenantId String
  name     String
  products Product[]

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model Stock {
  id        String @id @default(uuid())
  storeId   String
  productId String
  quantity  Int

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([storeId, productId])
}

model Customer {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  phone     String?
  email     String?
  createdAt DateTime @default(now())

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  transactions Transaction[]
}

model Transaction {
  id         String  @id @default(uuid()) // Custom ID like ORD-123
  tenantId   String
  storeId    String
  cashierId  String? // User ID
  customerId String?
  source     String? // "POS", "MARKET"

  totalAmount   Float
  paymentMethod String // CASH, QRIS, TRANSFER
  amountPaid    Float
  change        Float
  buyerFee      Float  @default(0)
  merchantFee   Float  @default(0)
  platformFee   Float  @default(0)
  deliveryFee   Float  @default(0) // [NEW] Delivery Cost

  // O2O Fields
  orderStatus     String // PENDING, COMPLETED, CANCELLED
  paymentStatus   PaymentStatus   @default(UNPAID)
  fulfillmentType FulfillmentType @default(DELIVERY)
  pickupCode      String?         @unique // For QR Scanning
  deliveryAddress String?

  // [NEW] O2O Fields
  customerName  String? // For Guest/Quick Buy without full account
  customerPhone String? // For WhatsApp coordination

  paymentProof String? // [NEW] URL/Path to proof
  paidAt       DateTime?

  occurredAt DateTime @default(now())

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  store    Store     @relation(fields: [storeId], references: [id])
  user     User?     @relation(fields: [cashierId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])

  transactionItems TransactionItem[]

  offlineId String? // [NEW] To map back to mobile device ID for idempotency

  @@unique([tenantId, offlineId]) // Ensure we don't double-sync the same offline txn
  @@index([storeId, occurredAt])
}

// ... (TransactionItem, etc.)

// [NEW] Central Settings (For Admin QRIS)
model SystemSettings {
  id          String   @id @default(uuid())
  key         String   @unique // e.g. "PLATFORM_QRIS_URL", "PLATFORM_BANK_INFO"
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model TransactionItem {
  id            String @id @default(uuid())
  transactionId String
  productId     String
  quantity      Int
  price         Float // Price at moment of sale
  
  // [NEW] Enriched Data (Snapshot)
  productName   String?
  productSku    String?
  productImage  String?
  basePrice     Float?   @default(0)

  transaction Transaction @relation(fields: [transactionId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])
}

// Reporting 
model DailySalesSummary {
  id         String   @id @default(uuid())
  tenantId   String
  storeId    String
  date       DateTime @db.Date
  totalSales Float
  totalTrans Int

  tenant Tenant @relation(fields: [tenantId], references: [id])
  store  Store  @relation(fields: [storeId], references: [id])

  @@unique([storeId, date])
}

model ProductSalesSummary {
  id           String   @id @default(uuid())
  tenantId     String
  productId    String
  date         DateTime @db.Date
  quantitySold Int
  totalRevenue Float

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum FulfillmentType {
  DELIVERY
  PICKUP
  DINE_IN
}

// ... existing models ...

model CashflowLog {
  id          String           @id @default(uuid())
  tenantId    String
  storeId     String
  amount      Decimal          @db.Decimal(15, 2)
  type        CashflowType // IN or OUT
  category    CashflowCategory // [UPDATED] Enum for better reporting
  description String?
  performedBy String? // User ID who did this
  occurredAt  DateTime

  tenant Tenant @relation(fields: [tenantId], references: [id])
  store  Store  @relation(fields: [storeId], references: [id])

  @@index([tenantId, occurredAt])
}

enum CashflowType {
  CASH_IN
  CASH_OUT
}

enum CashflowCategory {
  SALES // Auto-generated from Transactions
  EXPENSE_OPERATIONAL // Listrik, Air, Sewa
  EXPENSE_PURCHASE // Beli Bahan Baku
  EXPENSE_PETTY // Es batu, plastik, dll
  DEBT_PAYMENT // Bayar Utang
  RECEIVABLE_PAYMENT // Terima Pelunasan Kasbon
  CAPITAL_IN // Modal Masuk
  OTHER
  TOPUP
  TRANSFER
  WITHDRAWAL
}

model TopUpRequest {
  id        String        @id @default(uuid())
  storeId   String
  amount    Float
  proofUrl  String // Path to uploaded proof
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  store Store @relation(fields: [storeId], references: [id])
}

model WalletTransfer {
  id              String   @id @default(uuid())
  senderStoreId   String
  receiverStoreId String
  amount          Float
  note            String?
  createdAt       DateTime @default(now())

  sender   Store @relation("SentTransfers", fields: [senderStoreId], references: [id])
  receiver Store @relation("ReceivedTransfers", fields: [receiverStoreId], references: [id])
}

model DebtRecord {
  id           String    @id @default(uuid())
  tenantId     String
  storeId      String
  customerId   String? // Link to customer if applicable
  borrowerName String // Name manual if no customer entity
  amount       Decimal   @db.Decimal(15, 2)
  amountPaid   Decimal   @default(0) @db.Decimal(15, 2)
  dueDate      DateTime?
  phone        String?
  address      String?
  city         String?
  latitude     Float? // [NEW] For Location-based search
  longitude    Float? // [NEW] For Location-based search
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  store  Store  @relation(fields: [storeId], references: [id])
}

enum DebtStatus {
  UNPAID
  PARTIAL
  PAID
  BAD_DEBT
}

// ================================
// SYSTEM & AUDIT
// ================================

model SyncLog {
  id            String    @id @default(uuid())
  tenantId      String
  deviceId      String
  status        String // SUCCESS, PARTIAL, ERROR
  recordsSynced Int
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  errorMessage  String? // If failed
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String // "UPDATE_PRICE", "ADJUST_STOCK"
  entity     String // "Product", "Transaction"
  entityId   String
  oldValue   String?
  newValue   String?
  occurredAt DateTime @default(now())
}

// ================================
// B2B MARKETPLACE (KULAKAN) ISOMORPHIC SCHEME
// ================================

model WholesaleCategory {
  id        String   @id @default(uuid())
  name      String
  icon      String? // URL or Material Icon Name
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  products WholesaleProduct[]
}

model WholesaleProduct {
  id           String   @id @default(uuid())
  categoryId   String
  name         String
  description  String?
  price        Float
  stock        Int      @default(0)
  imageUrl     String?
  supplierName String? // e.g. "Official Partner"
  minOrder     Int      @default(1)
  isActive     Boolean  @default(true)
  soldCount    Int      @default(0)
  rating       Float    @default(0.0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  category   WholesaleCategory    @relation(fields: [categoryId], references: [id])
  orderItems WholesaleOrderItem[]
}

model WholesaleOrder {
  id              String               @id @default(uuid())
  tenantId        String
  storeId         String?
  totalAmount     Float
  status          WholesaleOrderStatus @default(PENDING)
  paymentMethod   String // "TRANSFER_BCA", "COD"
  shippingAddress String?
  shippingCost    Float                @default(0)

  // [NEW] Platform Fee
  serviceFee Float @default(0)

  // Coupon Fields
  couponCode     String?
  discountAmount Float   @default(0)

  // Verification
  proofUrl   String?
  pickupCode String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant               @relation(fields: [tenantId], references: [id])
  items  WholesaleOrderItem[]
}

model WholesaleOrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Float // Price at purchase time

  order   WholesaleOrder   @relation(fields: [orderId], references: [id])
  product WholesaleProduct @relation(fields: [productId], references: [id])
}

enum WholesaleOrderStatus {
  PENDING
  PAID
  PROCESSED
  SHIPPED
  DELIVERED
  CANCELLED
}

model WholesaleCoupon {
  id          String     @id @default(uuid())
  code        String     @unique
  type        CouponType
  value       Float // Amount or Percentage
  minOrder    Float      @default(0)
  maxDiscount Float? // Max discount amount for percentage type
  startDate   DateTime?
  endDate     DateTime?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
}

enum CouponType {
  PERCENTAGE
  FIXED
  FREE_SHIPPING
}

model WholesaleBanner {
  id          String   @id @default(uuid())
  title       String
  imageUrl    String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ================================
// FLASH SALE (Marketplace Promo)
// ================================

enum FlashSaleStatus {
  PENDING
  APPROVED
  ACTIVE
  REJECTED
  ENDED
}

model FlashSale {
  id        String          @id @default(uuid())
  tenantId  String
  storeId   String
  title     String
  startAt   DateTime
  endAt     DateTime
  status    FlashSaleStatus @default(PENDING)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  tenant Tenant          @relation(fields: [tenantId], references: [id])
  store  Store           @relation(fields: [storeId], references: [id])
  items  FlashSaleItem[]

  @@index([storeId, startAt, endAt])
}

model FlashSaleItem {
  id             String @id @default(uuid())
  flashSaleId    String
  productId      String
  salePrice      Float
  maxQtyPerOrder Int    @default(0) // 0 means unlimited
  saleStock      Int? // Optional limited stock

  flashSale FlashSale @relation(fields: [flashSaleId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])
}

// ================================
// ANALYTICS & REVENUE
// ================================

model PlatformRevenue {
  id          String        @id @default(uuid())
  amount      Float
  source      RevenueSource // SUBSCRIPTION, WITHDRAWAL_FEE
  description String? // e.g. "Upgrade to Premium - Toko A", "Fee from Withdrawal #123"
  referenceId String? // ID of SubscriptionRequest or Withdrawal
  createdAt   DateTime      @default(now())
}

enum RevenueSource {
  SUBSCRIPTION
  WITHDRAWAL_FEE
  OTHER
}

// ================================
// SUPPORT & TICKETING
// ================================

model SupportTicket {
  id        String         @id @default(uuid())
  tenantId  String
  storeId   String?
  subject   String
  status    TicketStatus   @default(OPEN)
  priority  TicketPriority @default(NORMAL)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  tenant   Tenant          @relation(fields: [tenantId], references: [id])
  messages TicketMessage[]
}

model TicketMessage {
  id         String     @id @default(uuid())
  ticketId   String
  senderType SenderType // MERCHANT or ADMIN
  senderId   String // User ID if known, or "SYSTEM"
  message    String
  isAdmin    Boolean    @default(false)
  createdAt  DateTime   @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SenderType {
  MERCHANT
  ADMIN
  SYSTEM
}

// ================================
// MOBILE APP CONFIGURATION
// ================================

model AppMenu {
  id        String   @id @default(uuid())
  key       String   @unique // e.g. "POS", "STOCK", "REPORT"
  label     String // Display Name
  icon      String // Icon Name (Lucide/Material)
  route     String // App Route / Screen Name
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ================================
// CONTENT MANAGEMENT SYSTEM (BLOG)
// ================================

model BlogPost {
  id          String    @id @default(uuid())
  title       String
  slug        String    @unique
  summary     String?
  content     String // Text or HTML
  imageUrl    String?
  author      String? // Name of author
  tags        String[]
  status      String    @default("DRAFT") // DRAFT, PUBLISHED
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ================================
// PPOB & DIGITAL PRODUCTS
// ================================

model DigitalProduct {
  id           String   @id @default(uuid())
  sku          String   @unique // e.g. "P5", "PLN20"
  name         String
  category     String // "pulsa", "pln", "game"
  brand        String? // "Telkomsel", "Indosat"
  price        Float // Base price from provider
  sellingPrice Float // Price sold to merchant/user
  isPromo      Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model PpobTransaction {
  id                   String   @id @default(uuid())
  tenantId             String
  storeId              String
  refId                String   @unique
  buyerSkuCode         String
  customerNo           String
  command              String
  status               String
  rc                   String?
  message              String?
  sn                   String?
  providerPrice        Float?
  providerSellingPrice Float?
  chargeAmount         Float?
  walletLogId          String?
  rawResponse          Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  store  Store  @relation(fields: [storeId], references: [id])

  @@index([tenantId, createdAt])
  @@index([storeId, createdAt])
}

enum ReferralProgramType {
  SINGLE_LEVEL
  MULTI_LEVEL
}

enum ReferralProgramStatus {
  DRAFT
  ACTIVE
  PAUSED
  ENDED
}

enum ReferralCodeStatus {
  ACTIVE
  DISABLED
  EXPIRED
}

enum ReferralStatus {
  PENDING_REWARD
  CANCELED
  COMPLETED
}

enum ReferralRewardStatus {
  CREATED
  HOLD
  ELIGIBLE
  RELEASED
  CANCELED
  CLAWED_BACK
}

model ReferralProgram {
  id           String                @id @default(uuid())
  name         String
  code         String                @unique
  type         ReferralProgramType   @default(SINGLE_LEVEL)
  status       ReferralProgramStatus @default(ACTIVE)
  maxLevels    Int                   @default(1)
  rewardL1     Float                 @default(0)
  rewardL2     Float                 @default(0)
  rewardL3     Float                 @default(0)
  holdDays     Int                   @default(0)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  referralCodes ReferralCode[]
  referrals     Referral[]
  rewards       ReferralReward[]
}

model ReferralCode {
  id        String             @id @default(uuid())
  programId String
  tenantId  String
  code      String             @unique
  status    ReferralCodeStatus @default(ACTIVE)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  program ReferralProgram @relation(fields: [programId], references: [id])
  tenant  Tenant          @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model Referral {
  id                String          @id @default(uuid())
  programId         String
  referrerTenantId  String
  refereeTenantId   String
  status            ReferralStatus  @default(PENDING_REWARD)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  program  ReferralProgram @relation(fields: [programId], references: [id])
  referrer Tenant          @relation("TenantAsReferrer", fields: [referrerTenantId], references: [id])
  referee  Tenant          @relation("TenantAsReferee", fields: [refereeTenantId], references: [id])
  rewards  ReferralReward[]
}

model ReferralReward {
  id                   String               @id @default(uuid())
  referralId           String
  programId            String
  beneficiaryTenantId  String
  level                Int
  amount               Float
  currency             String               @default("IDR")
  status               ReferralRewardStatus @default(HOLD)
  holdUntil            DateTime?
  releasedAt           DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  referral          Referral        @relation(fields: [referralId], references: [id])
  program           ReferralProgram @relation(fields: [programId], references: [id])
  beneficiaryTenant Tenant          @relation("ReferralRewardTenant", fields: [beneficiaryTenantId], references: [id])

  @@index([beneficiaryTenantId])
  @@index([status])
}
